<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Compras</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Sistema de Compras</h1>

    <div>
        <label>Saldo para invertir: </label>
        <input type="number" id="saldoInicial" value="0">
        <button onclick="setSaldo()">Establecer saldo</button>
    </div>

    <hr>

    <div>
        <h2>Registrar compra</h2>
        <input type="text" id="itemName" placeholder="Nombre del artículo">
        <input type="number" id="itemAmount" placeholder="Costo del artículo">
        <button onclick="addPurchase()">Registrar compra</button>
    </div>

    <hr>

    <h2>Saldo disponible: <span id="saldoActual">0</span></h2>

    <h2>Historial de compras</h2>
    <ul id="history"></ul>

<script>
    // Tus credenciales (anon key segura para frontend)
    const supabaseUrl = "https://ttbysnzxcdosxyveagdp.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0Ynlzbnp4Y2Rvc3h5dmVhZ2RwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzUxNzIsImV4cCI6MjA4MDU1MTE3Mn0.jHP6Uho1PuvUkuUuW-Y3BfdrkdJjqb5ZbRomSs-sGmo";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let saldo = 0;

    function setSaldo() {
        saldo = parseFloat(document.getElementById("saldoInicial").value);
        updateSaldoDisplay();
    }

    async function addPurchase() {
        const name = document.getElementById("itemName").value;
        const amount = parseFloat(document.getElementById("itemAmount").value);

        if (!name || !amount) {
            alert("Completa todos los campos.");
            return;
        }

        if (amount > saldo) {
            alert("La compra excede tu saldo disponible.");
            return;
        }

        saldo -= amount;
        updateSaldoDisplay();

        const { error } = await supabase
            .from('transactions')
            .insert([{ name, amount, type: "compra" }]);

        if (error) {
            alert("Error al registrar compra.");
            console.error(error);
            return;
        }

        document.getElementById("itemName").value = "";
        document.getElementById("itemAmount").value = "";

        loadHistory();
    }

    function updateSaldoDisplay() {
        document.getElementById("saldoActual").innerText = saldo.toFixed(2);
    }

    async function loadHistory() {
        const { data, error } = await supabase
            .from('transactions')
            .select('*')
            .eq('type', 'compra')
            .order('created_at', { ascending: false });

        if (error) {
            console.error(error);
            return;
        }

        const historyEl = document.getElementById("history");
        historyEl.innerHTML = "";

        data.forEach(item => {
            const li = document.createElement("li");
            li.innerText = `${item.name} - $${item.amount}`;
            historyEl.appendChild(li);
        });
    }

    loadHistory();
</script>
</body>
</html>
