<!DOCTYPE html>

<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingresar Productos</title>
  <style>
    :root {
      --primary-dark: #1a1a2e;
      --secondary-dark: #16213e;
      --accent-color: #0ea5e9;
      --accent-hover: #0284c7;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --success: #10b981;
      --text-light: #f8fafc;
      --text-muted: #94a3b8;
      --card-bg: #1e293b;
      --border-color: #334155;
      --input-bg: #0f172a;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
      color: var(--text-light);
      min-height: 100vh; padding:20px; line-height:1.6;
    }
    .container { max-width:800px; margin:0 auto; }
    header { text-align:center; margin-bottom:30px; padding:20px 0; border-bottom:1px solid var(--border-color); }
    h1 { font-size:2.5rem; background: linear-gradient(90deg, var(--accent-color), #6366f1); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:10px; }
    .subtitle { color: var(--text-muted); font-size:1.1rem; }
    .card { background: var(--card-bg); border:1px solid var(--border-color); border-radius:16px; padding:24px; margin-bottom:24px; box-shadow:0 10px 25px rgba(0,0,0,0.3); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card:hover { transform:translateY(-5px); box-shadow:0 15px 35px rgba(0,0,0,0.4); }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .card-title { font-size:1.5rem; font-weight:600; color: var(--accent-color); }
    .balance-display { text-align:center; padding:30px 20px; }
    .balance-label { font-size:1rem; color: var(--text-muted); margin-bottom:8px; }
    .balance-amount { font-size:3.5rem; font-weight:700; color: var(--success); text-shadow:0 2px 10px rgba(16,185,129,0.3); }
    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; font-weight:500; color: var(--text-muted); }
    input, select, textarea { width:100%; padding:14px 16px; background: var(--input-bg); border:2px solid var(--border-color); border-radius:12px; color: var(--text-light); font-size:1rem; transition: all 0.3s ease; }
    input:focus { outline:none; border-color: var(--accent-color); box-shadow:0 0 0 3px rgba(14,165,233,0.2); }
    .btn { padding:14px 28px; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition: all 0.3s ease; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
    .btn-primary { background: linear-gradient(135deg, var(--accent-color), #2563eb); color:white; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--accent-hover), #1d4ed8); transform: translateY(-2px); box-shadow:0 5px 15px rgba(14,165,233,0.4); }
    .btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color:white; }
    .btn-danger:hover { background: linear-gradient(135deg, var(--danger-hover), #b91c1c); transform: translateY(-2px); box-shadow:0 5px 15px rgba(239,68,68,0.4); }
    .btn-success { background: linear-gradient(135deg, var(--success), #059669); color:white; }
    .btn-success:hover { background: linear-gradient(135deg, #0da271, #047857); transform: translateY(-2px); box-shadow:0 5px 15px rgba(16,185,129,0.4); }
    .btn-outline { background:transparent; border:2px solid var(--accent-color); color: var(--accent-color); }
    .btn-outline:hover { background: var(--accent-color); color:white; }
    .grid { display:grid; gap:20px; }
    .grid-2 { grid-template-columns: repeat(2,1fr); }
    .grid-3 { grid-template-columns: repeat(3,1fr); }
    .flex { display:flex; gap:15px; align-items:center; }
    .flex-wrap { flex-wrap:wrap; }
    .nav-buttons { display:flex; gap:15px; margin-top:30px; flex-wrap:wrap; }
    #status { padding:15px; margin:20px 0; border-radius:12px; background: rgba(16,185,129,0.1); border-left:4px solid var(--success); color: var(--text-light); font-weight:500; }
    .status-error { background: rgba(239,68,68,0.1) !important; border-left-color: var(--danger) !important; }
    @media(max-width:767px){.container{padding:0 15px;} h1{font-size:2rem;} .balance-amount{font-size:2.5rem;} .flex{flex-direction:column;gap:10px;} .btn{width:100%;padding:16px;} .nav-buttons{flex-direction:column;} .card{padding:20px;} }
    @media(max-width:480px){body{padding:15px;} .balance-amount{font-size:2rem;} .card-title{font-size:1.25rem;}}
    .btn:disabled { opacity:0.6; cursor:not-allowed; transform:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè™ Gestor de Compras</h1>
      <p class="subtitle">Administra tu inventario y saldo de forma eficiente</p>
    </header>

<!-- Saldo Section -->
<div class="card">
  <div class="card-header">
    <h2 class="card-title">üíº Saldo Disponible</h2>
  </div>
  <div class="balance-display">
    <div class="balance-label">Tu saldo actual es:</div>
    <div id="saldoDisplay" class="balance-amount">$0.00</div>
  </div>
  <div class="form-group">
    <label for="initialBalance">Actualizar Saldo:</label>
    <input type="number" step="0.01" id="initialBalance" min="0" placeholder="Ej: 1500.00">
  </div>
  <div class="flex flex-wrap">
    <button id="guardarSaldoBtn" class="btn btn-primary">üíæ Guardar Saldo</button>
    <button id="resetSaldoBtn" class="btn btn-danger">üîÑ Reiniciar a Cero</button>
  </div>
</div>

<!-- Agregar Producto Section -->
<div class="card">
  <div class="card-header">
    <h2 class="card-title">üì¶ Agregar Producto</h2>
  </div>
  <form id="productForm">
    <div class="grid grid-3">
      <div class="form-group">
        <label for="name">Nombre del Producto:</label>
        <input type="text" id="name" required placeholder="Ej: Laptop HP">
      </div>
      <div class="form-group">
        <label for="quantity">Cantidad:</label>
        <input type="number" id="quantity" min="1" value="1" required>
      </div>
      <div class="form-group">
        <label for="price">Precio Unitario:</label>
        <input type="number" step="0.01" id="price" min="0" value="0.00" required>
      </div>
    </div>
    <button type="submit" class="btn btn-success" style="margin-top:20px;">‚ûï Guardar Producto</button>
  </form>
</div>

<!-- Navigation -->
<div class="nav-buttons">
  <button onclick="window.location.href='dashboard.html'" class="btn btn-outline">üìä Ir al Dashboard</button>
</div>

<div id="status"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const supabase = window.supabase.createClient(
      "https://xwdqhycpndqgeasqotzw.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3ZHFoeWNwbmRxZ2Vhc3FvdHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDQwNTEsImV4cCI6MjA4MDUyMDA1MX0.wF57-5tLs2T-VYQvcmQ69-JsJWp-DmnCJ86ZQ79y97Y" // reemplaza por tu anon key
    );

    let currentBalance = 0;
    const WALLET_ID = 1;

    async function cargarSaldo() {
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Cargando saldo...';
      try {
        const { data, error } = await supabase.from('wallet').select('*').eq('id', WALLET_ID).single();
        if (error) {
          // Si no existe, crear uno
          const { data: inserted } = await supabase.from('wallet').insert([{ id: WALLET_ID, balance: 0 }]).select().single();
          currentBalance = parseFloat(inserted.balance);
        } else {
          currentBalance = parseFloat(data.balance);
        }
        document.getElementById('saldoDisplay').innerText = `$${currentBalance.toFixed(2)}`;
        statusEl.textContent = 'Saldo cargado correctamente';
        setTimeout(() => statusEl.textContent='', 2000);
      } catch (error) {
        statusEl.textContent = 'Error al cargar saldo: '+error.message;
        statusEl.classList.add('status-error');
      }
    }

    async function guardarSaldo() {
      const val = parseFloat(document.getElementById('initialBalance').value);
      const statusEl = document.getElementById('status');
      if (isNaN(val) || val < 0) { statusEl.textContent='Ingresa un saldo v√°lido (‚â•0)'; statusEl.classList.add('status-error'); return; }
      try {
        const { error } = await supabase.from('wallet').upsert({ id: WALLET_ID, balance: val, updated_at: new Date() }, { onConflict:'id' });
        if (error) throw error;
        currentBalance = val;
        document.getElementById('saldoDisplay').innerText = `$${currentBalance.toFixed(2)}`;
        document.getElementById('initialBalance').value='';
        statusEl.textContent='‚úÖ Saldo actualizado';
        statusEl.classList.remove('status-error');
      } catch(e) { statusEl.textContent='‚ùå Error: '+e.message; statusEl.classList.add('status-error'); }
    }

    async function resetSaldo() {
      if(!confirm('¬øSeguro que quieres reiniciar el saldo a $0.00?')) return;
      const statusEl = document.getElementById('status');
      try {
        const { error } = await supabase.from('wallet').update({ balance:0, updated_at:new Date() }).eq('id', WALLET_ID);
        if (error) throw error;
        currentBalance = 0;
        document.getElementById('saldoDisplay').innerText='$0.00';
        statusEl.textContent='‚úÖ Saldo reiniciado';
        statusEl.classList.remove('status-error');
      } catch(e){ statusEl.textContent='‚ùå Error: '+e.message; statusEl.classList.add('status-error'); }
    }

    document.getElementById('guardarSaldoBtn').addEventListener('click', guardarSaldo);
    document.getElementById('resetSaldoBtn').addEventListener('click', resetSaldo);

    document.getElementById('productForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const statusEl = document.getElementById('status'); statusEl.textContent=''; statusEl.classList.remove('status-error');
      const name = document.getElementById('name').value.trim();
      const quantity = parseInt(document.getElementById('quantity').value);
      const price = parseFloat(document.getElementById('price').value);
      const submitBtn = document.querySelector('#productForm button[type="submit"]');

      if(!name || isNaN(quantity) || isNaN(price) || quantity<=0 || price<0){
        statusEl.textContent='‚ùå Revisa los datos del producto'; statusEl.classList.add('status-error'); return;
      }

      const total = +(quantity*price).toFixed(2);
      if(total>currentBalance){
        statusEl.innerHTML=`‚ùå <strong>Saldo insuficiente</strong><br>Requerido: $${total.toFixed(2)}<br>Disponible: $${currentBalance.toFixed(2)}`;
        statusEl.classList.add('status-error'); return;
      }

      submitBtn.disabled=true; submitBtn.innerHTML='‚è≥ Procesando...';
      try{
        const { error: productError } = await supabase.from('products').insert([{ name, quantity, price }]);
        if(productError) throw productError;
        const newBalance = +(currentBalance-total).toFixed(2);
        const { error: updateError } = await supabase.from('wallet').update({ balance:newBalance, updated_at:new Date() }).eq('id', WALLET_ID);
        if(updateError) throw updateError;
        currentBalance=newBalance;
        document.getElementById('saldoDisplay').innerText=`$${currentBalance.toFixed(2)}`;
        statusEl.innerHTML=`‚úÖ <strong>Producto guardado</strong><br>Se descont√≥: $${total.toFixed(2)}<br>Nuevo saldo: $${currentBalance.toFixed(2)}`;
        document.getElementById('productForm').reset();
      } catch(e){ statusEl.textContent='‚ùå Error: '+e.message; statusEl.classList.add('status-error'); }
      finally{ submitBtn.disabled=false; submitBtn.innerHTML='‚ûï Guardar Producto'; }
    });

    cargarSaldo();
    document.getElementById('name').focus();
  </script>

</body>
</html>
