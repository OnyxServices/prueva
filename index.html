<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Compras</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Sistema de Compras</h1>

```
<div>
    <label>Saldo para invertir: </label>
    <input type="number" id="saldoInicial" value="0">
    <button onclick="setSaldo()">Establecer saldo</button>
</div>

<hr>

<div>
    <h2>Registrar compra</h2>
    <input type="text" id="itemName" placeholder="Nombre del artículo">
    <input type="number" id="itemAmount" placeholder="Costo del artículo">
    <button onclick="addPurchase()">Registrar compra</button>
</div>

<hr>

<h2>Saldo disponible: <span id="saldoActual">0</span></h2>

<h2>Historial de compras</h2>
<ul id="history"></ul>
```

<script>
    // Configuración de Supabase
    const supabaseUrl = "https://ttbysnzxcdosxyveagdp.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0Ynlzbnp4Y2Rvc3h5dmVhZ2RwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzUxNzIsImV4cCI6MjA4MDU1MTE3Mn0.jHP6Uho1PuvUkuUuW-Y3BfdrkdJjqb5ZbRomSs-sGmo";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let saldo = 0;

    // Cargar saldo inicial desde la base de datos
    async function loadSaldo() {
        const { data, error } = await supabase
            .from('wallet')
            .select('saldo')
            .eq('id', 1)
            .single();

        if (error) {
            console.error("Error al cargar saldo:", error);
            return;
        }

        saldo = data ? parseFloat(data.saldo) : 0;
        updateSaldoDisplay();
    }

    // Guardar o actualizar saldo
    async function setSaldo() {
        saldo = parseFloat(document.getElementById("saldoInicial").value);
        if (isNaN(saldo) || saldo < 0) {
            alert("Ingresa un saldo válido.");
            return;
        }

        const { error } = await supabase
            .from('wallet')
            .upsert({ id: 1, saldo });

        if (error) {
            console.error("Error al guardar saldo:", error);
            alert("No se pudo guardar el saldo.");
            return;
        }

        updateSaldoDisplay();
        loadHistory();
    }

    // Registrar compra
    async function addPurchase() {
        const name = document.getElementById("itemName").value.trim();
        const amount = parseFloat(document.getElementById("itemAmount").value);

        if (!name || isNaN(amount) || amount <= 0) {
            alert("Completa todos los campos con valores válidos.");
            return;
        }

        if (amount > saldo) {
            alert("La compra excede tu saldo disponible.");
            return;
        }

        saldo -= amount;
        updateSaldoDisplay();

        const { error: purchaseError } = await supabase
            .from('transactions')
            .insert([{ name, amount, type: "compra" }]);

        if (purchaseError) {
            alert("Error al registrar compra.");
            console.error(purchaseError);
            saldo += amount; 
            updateSaldoDisplay();
            return;
        }

        const { error: saldoError } = await supabase
            .from('wallet')
            .update({ saldo })
            .eq('id', 1);

        if (saldoError) {
            console.error("Error al actualizar saldo:", saldoError);
        }

        document.getElementById("itemName").value = "";
        document.getElementById("itemAmount").value = "";

        loadHistory();
    }

    // Actualizar visualización de saldo
    function updateSaldoDisplay() {
        document.getElementById("saldoActual").innerText = saldo.toFixed(2);
    }

    // Cargar historial de compras
    async function loadHistory() {
        const { data, error } = await supabase
            .from('transactions')
            .select('*')
            .eq('type', 'compra')
            .order('created_at', { ascending: false });

        if (error) {
            console.error(error);
            return;
        }

        const historyEl = document.getElementById("history");
        historyEl.innerHTML = "";

        data.forEach(item => {
            const li = document.createElement("li");
            li.innerText = `${item.name} - $${item.amount}`;
            historyEl.appendChild(li);
        });
    }

    loadSaldo();
    loadHistory();
</script>

</body>
</html>


